/*
 * Intel WebRTC SDK version 3.1.0
 * Copyright (c) 2016 Intel <http://webrtc.intel.com>
 * Homepage: http://webrtc.intel.com
 */


!function(a){function b(a){"use strict";this.type=a.type,this.attributes=a.attributes}function c(a){"use strict";var b=this,c=new SignalingChannel;this.onConnected=null,this.onDisconnected=null,this.onConnectFailed=null,this.onChatInvitation=null,this.onChatDenied=null,this.onChatStopped=null,this.onChatAccepted=null,this.onChatSignal=null,this.onStreamType=null,this.onAuthenticated=null,c.onMessage=function(a,c){var d=JSON.parse(a);switch(d.type){case"chat-invitation":b.onChatInvitation&&b.onChatInvitation(c);break;case"chat-accepted":b.onChatAccepted&&b.onChatAccepted(c);break;case"chat-denied":b.onChatDenied&&b.onChatDenied(c);break;case"chat-closed":b.onChatStopped&&b.onChatStopped(c);break;case"stream-type":b.onStreamType&&b.onStreamType(d.data,c);break;case"chat-signal":b.onChatSignal&&b.onChatSignal(d.data,c);break;case"chat-negotiation-needed":b.onNegotiationNeeded&&b.onNegotiationNeeded(c);break;case"chat-negotiation-accepted":b.onNegotiationAccepted&&b.onNegotiationAccepted(c);break;default:e.Logger.error("Received unkown message")}},c.onServerDisconnected=function(){b.onDisconnected&&b.onDisconnected()},this.sendChatInvitation=function(a,b,d){var e={type:"chat-closed"};c.sendMessage(JSON.stringify(e),a),e={type:"chat-invitation"},c.sendMessage(JSON.stringify(e),a,b,d)},this.sendChatAccepted=function(a,b,d){var e={type:"chat-accepted"};c.sendMessage(JSON.stringify(e),a,b,d)},this.sendChatDenied=function(a,b,d){var e={type:"chat-denied"};c.sendMessage(JSON.stringify(e),a,b,d)},this.sendChatStopped=function(a,b,d){var e={type:"chat-closed"};c.sendMessage(JSON.stringify(e),a,b,d)},this.sendStreamType=function(a,b,d,e){var f={type:"stream-type",data:b};c.sendMessage(JSON.stringify(f),a,d,e)},this.sendSignalMessage=function(a,b,d,e){var f={type:"chat-signal",data:b};c.sendMessage(JSON.stringify(f),a,d,e)},this.sendNegotiationNeeded=function(a,b,d){var e={type:"chat-negotiation-needed"};c.sendMessage(JSON.stringify(e),a,b,d)},this.sendNegotiationAccepted=function(a,b,d){var e={type:"chat-negotiation-accepted"};c.sendMessage(JSON.stringify(e),a,b,d)},this.finalize=function(){c.disconnect()},this.connect=function(a,d,e){c.connect(a,function(a){b.onConnected&&b.onConnected(),b.onAuthenticated&&b.onAuthenticated(a),d&&d(a)},e)}}var d=function(){"use strict";var a={};return Object.defineProperties(a,{version:{get:function(){return"3.0.0"}},name:{get:function(){return"Intel WebRTC SDK"}}}),a}(),e={},f={};d.EventDispatcher=function(a){"use strict";var b={};return a.dispatcher={},a.dispatcher.eventListeners={},b.addEventListener=function(b,c){void 0===a.dispatcher.eventListeners[b]&&(a.dispatcher.eventListeners[b]=[]),a.dispatcher.eventListeners[b].push(c)},b.on=b.addEventListener,b.removeEventListener=function(b,c){if(a.dispatcher.eventListeners[b]){var d=a.dispatcher.eventListeners[b].indexOf(c);-1!==d&&a.dispatcher.eventListeners[b].splice(d,1)}},b.clearEventListener=function(b){a.dispatcher.eventListeners[b]=[]},b.dispatchEvent=function(b){a.dispatcher.eventListeners[b.type]&&a.dispatcher.eventListeners[b.type].map(function(a){a(b)})},b},d.StreamEvent=function(a){"use strict";b.call(this,a),this.stream=a.stream,this.msg=a.msg},d.ClientEvent=function(a){"use strict";b.call(this,a),this.user=a.user},d.MessageEvent=function(a){"use strict";b.call(this,a),this.msg=a.msg},d.ChatEvent=function(a){"use strict";b.call(this,a),this.type=a.type,this.senderId=a.senderId,this.peerId=a.peerId},d.DataEvent=function(a){"use strict";b.call(this,a),this.type=a.type,this.senderId=a.senderId,this.data=a.data},d.RecorderEvent=function(a){"use strict";b.call(this,a),this.recorderId=a.id},d.StreamEvent.prototype=Object.create(b.prototype),d.StreamEvent.prototype.constructor=d.StreamEvent,d.ClientEvent.prototype=Object.create(b.prototype),d.ClientEvent.prototype.constructor=d.ClientEvent,d.MessageEvent.prototype=Object.create(b.prototype),d.MessageEvent.prototype.constructor=d.MessageEvent,d.ChatEvent.prototype=Object.create(b.prototype),d.ChatEvent.prototype.constructor=d.ChatEvent,d.DataEvent.prototype=Object.create(b.prototype),d.DataEvent.prototype.constructor=d.DataEvent,d.RecorderEvent.prototype=Object.create(b.prototype),d.RecorderEvent.prototype.constructor=d.RecorderEvent,e.Base64=function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l;for(a=-1,b=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],c=[],f=0;f<b.length;f+=1)c[b[f]]=f;return g=function(a){d=a,e=0},h=function(){var b;return d?e>=d.length?a:(b=255&d.charCodeAt(e),e+=1,b):a},i=function(c){var d,e,f;for(g(c),d="",e=new Array(3),f=!1;!f&&(e[0]=h())!==a;)e[1]=h(),e[2]=h(),d+=b[e[0]>>2],e[1]!==a?(d+=b[e[0]<<4&48|e[1]>>4],e[2]!==a?(d+=b[e[1]<<2&60|e[2]>>6],d+=b[63&e[2]]):(d+=b[e[1]<<2&60],d+="=",f=!0)):(d+=b[e[0]<<4&48],d+="=",d+="=",f=!0);return d},j=function(){if(!d)return a;for(;;){if(e>=d.length)return a;var b=d.charAt(e);if(e+=1,c[b])return c[b];if("A"===b)return 0}},k=function(a){return a=a.toString(16),1===a.length&&(a="0"+a),a="%"+a,unescape(a)},l=function(b){var c,d,e;for(g(b),c="",d=new Array(4),e=!1;!e&&(d[0]=j())!==a&&(d[1]=j())!==a;)d[2]=j(),d[3]=j(),c+=k(d[0]<<2&255|d[1]>>4),d[2]!==a?(c+=k(d[1]<<4&255|d[2]>>2),d[3]!==a?c+=k(d[2]<<6&255|d[3]):e=!0):e=!0;return c},{encodeBase64:i,decodeBase64:l}}(),e.Logger=function(){"use strict";var a,b,c,d,e,f,g,h=0,i=1,j=2,k=3,l=4,m=5,n=h;return a=function(a){a>m?a=m:h>a&&(a=h),n=a},b=function(){var a=arguments[0],b=arguments;if(!(n>a)){switch(a){case h:b[0]="DEBUG:";break;case i:b[0]="TRACE:";break;case j:b[0]="INFO:";break;case k:b[0]="WARNING:";break;case l:b[0]="ERROR:";break;default:return}console.log.apply(console,b)}},c=function(){for(var a=[h],c=0;c<arguments.length;c++)a.push(arguments[c]);b.apply(this,a)},d=function(){for(var a=[i],c=0;c<arguments.length;c++)a.push(arguments[c]);b.apply(this,a)},e=function(){for(var a=[j],c=0;c<arguments.length;c++)a.push(arguments[c]);b.apply(this,a)},f=function(){for(var a=[k],c=0;c<arguments.length;c++)a.push(arguments[c]);b.apply(this,a)},g=function(){for(var a=[l],c=0;c<arguments.length;c++)a.push(arguments[c]);b.apply(this,a)},{DEBUG:h,TRACE:i,INFO:j,WARNING:k,ERROR:l,NONE:m,setLogLevel:a,log:b,debug:c,trace:d,info:e,warning:f,error:g}}(),d.ieplugin={};var g=0;d.globalLocalView=null,d.globalLocalStream={};var h=function(a){var b=this;this.stream=a,this.stop=function(){b.stream.stop()}};d.ieplugin.ieMediaStream=function(a){"use strict";var b=this;this.id=a,this.attachedPCID=0,this.label=a,this.ended=!1,this.stopped=!1,this.closed=!1,this.onaddtrack=null,this.onended=null,this.onremovetrack=null,this.audioTracks=[new h(b)],this.videoTracks=[new h(b)],this.getTracks=function(){return b.audioTracks.concat(b.videoTracks)},this.getAudioTracks=function(){return b.audioTracks},this.getVideoTracks=function(){return b.videoTracks},this.addTrack=function(a){},this.removeTrack=function(a){},this.stop=function(){if(b.stopped===!1){var a=document.getElementById("WebRTC.ActiveX"+b.attachedPCID);if(void 0!==a)try{a.stopStream(b)}catch(c){console.log("An exception is thrown in server")}b.stopped=!0,b.closed=!0}},this.close=function(){if(b.closed===!1){var a=document.getElementById("WebRTC.ActiveX"+b.attachedPCID);if(void 0!==a)try{a.removeStream(b)}catch(c){console.log("An exception is thrown in server")}b.closed=!0}}},d.ieplugin.ieRTCDataChannel=function(a,b){"use strict";var c=this,d=[];this.attachedPCID=b,this.activeX=document.getElementById("WebRTC.ActiveX"+c.attachedPCID),this.label=a,this.onmessage=null,this.onopen=null,this.onerror=null,this.onclose=null,this.readyState="connecting",this.activeX.onmessage=function(a){var b={};if(b.data=a,d.push(b),c.onmessage){for(var e=0;e<d.length;e++)c.onmessage(d[e]);d=[]}},this.activeX.onopen=function(a){var b={};b.target=c,c.readyState="open",c.open&&c.onopen(b)},this.activeX.onerror=function(){c.onerror()},this.activeX.onclose=function(){var a={};a.target=c,c.readyState="closed",c.onclose&&c.onclose(a)},this.close=function(){c.activeX&&c.activeX.closeDataChannel(c.label)},this.send=function(a){c.activeX&&c.activeX.send(a)}},d.ieplugin.ieRTCPeerConnection=function(a,b){var c=this;this.myId=g+1,g+=1;var e=document.createElement("OBJECT");e.setAttribute("ID","WebRTC.ActiveX"+c.myId),e.setAttribute("height","0"),e.setAttribute("width","0"),e.setAttribute("CLASSID","CLSID:1D117433-FD6F-48D2-BF76-26E2DC5390FC"),document.body.appendChild(e),c.activeX=document.getElementById("WebRTC.ActiveX"+c.myId),null!=a&&(a=a.iceServers,this.config=JSON.stringify(a)),null!=b&&(this.constraints=JSON.stringify(b)),this.activeX.initializePeerConnection(this.config,this.constraints),this.createAnswer=function(a,b,d){c.activeX.createAnswer(function(b){a(JSON.parse(b))},b,JSON.stringify(d))},this.setLocalDescription=function(a,b,d){c.activeX.setLocalDescription(a,b,d)},this.setRemoteDescription=function(a,b,d){c.activeX.setRemoteDescription(a,b,d)},this.addStream=function(a){c.activeX.getUserMedia(a.constraints,function(b){var e=new d.ieplugin.ieMediaStream(b),f=d.globalLocalView.getContext("2d"),g=new Image;c.activeX.attachMediaStream(e.label,function(a){try{g.src=a,f.drawImage(g,0,0,d.globalLocalView.width,d.globalLocalView.height)}catch(b){console.log("err:"+b)}}),c.activeX.addStream(e),a.id=e.label,d.globalLocalStream.ieStream=e},a.onfailure)},this.createOffer=function(a,b,d){c.activeX&&c.activeX.createOffer(function(b){a(JSON.parse(b))},b,JSON.stringify(d))},this.removeStream=function(a){c.activeX&&c.activeX.removeStream(a)},this.addIceCandidate=function(a,b,d){c.activeX&&c.activeX.addIceCandidate(a,b,d)},this.getStats=function(a){c.activeX.getStats(function(b){a(b)})},this.getAudioLevels=function(a){c.activeX.getAudioLevels(a)},this.close=function(){if(c.activeX)try{c.activeX.close()}catch(a){console.log("exception when closing the control")}var b=document.getElementById("WebRTC.ActiveX"+c.myId);b&&(c.activeX.closeDataChannel(c.label),document.body.removeChild(b),c.activeX=void 0)},this.createDataChannel=function(a,b){c.activeX&&c.activeX.createDataChannel(a,b);var e=new d.ieplugin.ieRTCDataChannel(a,c.myId);return e},this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.oniceconnectionstatechange=null,this.onsignalingstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.activeX.onicecandidate=function(a){var b=JSON.parse(a);c.onicecandidate&&c.onicecandidate(b)},this.activeX.onaddstream=function(a){var b={},e=new d.ieplugin.ieMediaStream(a);e.attachedPCID=c.myId,b.stream=e,b.pcid=c.myId,c.onaddstream&&c.onaddstream(b)},this.activeX.onremovestream=function(a){var b={},e=new d.ieplugin.ieMediaStream(a);b.stream=e,c.onremovestream&&c.onremovestream(b)},this.activeX.oniceconnectionstatechange=function(a){c.iceConnectionState=a,c.oniceconnectionstatechange&&c.oniceconnectionstatechange(a)},this.activeX.onsignalingstatechange=function(a){c.signalingState=a,c.onsignalingstatechange&&c.onsignalingstatechange()},this.activeX.onnegotiationneeded=function(){c.onnegotiationneeded&&c.onnegotiationneeded()},this.activeX.ondatachannel=function(a){var b={},e=new d.ieplugin.ieRTCDataChannel(a,c.myId);b.channel=e,c.ondatachannel&&c.ondatachannel(b)},this.iceConnectionState="new",this.signalingState="stable"},function(){"use strict";function b(a){this.mediaStream=a.mediaStream,a.attributes=a.attributes||{},this.url=function(){return"string"==typeof a.url&&""!==a.url?a.url:void 0},this.hasVideo=function(){return!!a.video},this.hasAudio=function(){return!!a.audio},this.attributes=function(){return a.attributes},this.attr=function(b,c){return arguments.length>1&&(a.attributes[b]=c),a.attributes[b]},this.id=function(){return a.id||null},this.isScreen=function(){return!!a.video&&"screen"===a.video.device},this.bitRate={maxVideoBW:void 0,maxAudioBW:void 0},this.toJson=function(){return{id:this.id(),audio:a.audio,video:a.video,attributes:a.attributes}}}function c(a){b.call(this,a)}function f(a){b.call(this,a),this.isMixed=function(){return!1},this.from=a.from;var c={},d=this;Object.defineProperties(this,{on:{get:function(){return function(a,b){return c[a]=c[a]||[],c[a].push(b),d}}},emit:{get:function(){return function(a){if(c[a]){var b=[].slice.call(arguments,1);c[a].map(function(a){a.apply(d,b)})}return d}}},removeListener:{get:function(){return function(a,b){return void 0===b?c[a]=[]:c[a]&&c[a].map(function(d,e){d===b&&c[a].splice(e,1)}),d}}},clearListeners:{get:function(){return function(){return c={},d}}}})}function g(a){f.call(this,a),this.resolutions=function(){return a.video.resolutions instanceof Array?a.video.resolutions.map(function(a){return a}):[]},this.isMixed=function(){return!0}}function h(a){this.url=function(){return"string"==typeof a.url&&""!==a.url?a.url:void 0},this.id=function(){return a.id||null},this.hasVideo=function(){return!0},this.hasAudio=function(){return!0},this.toJson=function(){return{id:this.id(),audio:!0,video:{device:"camera"},url:this.url()}}}function i(){return null!==a.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&a.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function j(){return a.navigator.appVersion.indexOf("Trident")>-1}function k(){return null!==a.navigator.userAgent.match("Firefox")}function l(){return k()||null!==a.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&a.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]>=34}function m(a,b){return{mandatory:{minWidth:a,minHeight:b,maxWidth:a,maxHeight:b},optional:[]}}function n(a,b){if("object"==typeof a&&null!==a&&void 0!==a.url){var c="URL for LocalStream is deprecated, please use ExternalStream instead.";"function"==typeof console.warn?console.warn(c):e.Logger.warning(c);var f=new d.LocalStream(a);return void("function"==typeof b&&b(null,f))}if("function"!=typeof q&&!j())return void("function"==typeof b&&b({code:1100,msg:"webrtc support not available"}));var g=arguments[3];void 0===g&&(g=2);var h={};if(null!==a&&"object"==typeof a){if(a.video){if((void 0===typeof a.video||"object"!=typeof a.video&&a.video)&&(a.video=Object.create({})),"string"!=typeof a.video.device&&(a.video.device="camera"),"screen"===a.video.device&&!l()&&"function"==typeof b)return void b({code:1103,msg:"browser screen sharing not supported"});"object"==typeof a.video.resolution&&void 0!==a.video.resolution.width&&void 0!==a.video.resolution.height?h.video=JSON.parse(JSON.stringify(m(a.video.resolution.width,a.video.resolution.height))):h.video=JSON.parse(JSON.stringify(p[a.video.resolution]||p.unspecified)),j()||!i()&&a.video.frameRate instanceof Array&&a.video.frameRate.length>=2&&(h.video.mandatory.minFrameRate=a.video.frameRate[0],h.video.mandatory.maxFrameRate=a.video.frameRate[1])}a.audio&&(h.audio=!0)}else if("function"==typeof b)return void b({code:1107,msg:"USER_INPUT_INVALID"});var o=function(c){a.mediaStream=c;var e=new d.LocalStream(a);if(a.video&&"screen"===a.video.device&&(c.onended=function(){e.close()}),h.video)switch(h.video.mandatory.maxWidth){case 320:e.bitRate.maxVideoBW=512;break;case 640:e.bitRate.maxVideoBW=1024;break;case 1280:e.bitRate.maxVideoBW=2048}"function"==typeof b&&b(null,e)},r=function(c){var d={code:1100,msg:c.name||c};switch(d.msg){case"Starting video failed":case"TrackStartError":if(a.video={device:a.video.device,extensionId:a.video.extensionId},g>0)return void setTimeout(function(){n(a,b,g-1)},1);d.msg="MEDIA_OPTION_INVALID",d.code=1104;break;case"DevicesNotFoundError":d.msg="DEVICES_NOT_FOUND",d.code=1102;break;case"NotSupportedError":d.msg="NOT_SUPPORTED",d.code=1105;break;case"PermissionDeniedError":d.msg="PERMISSION_DENIED",d.code=1101;break;case"PERMISSION_DENIED":d.code=1101;break;case"ConstraintNotSatisfiedError":d.msg="CONSTRAINT_NOT_SATISFIED",d.code=1106;break;default:d.msg||(d.msg="UNDEFINED")}"function"==typeof b&&b(d)};if(a.video&&"screen"===a.video.device){if(k())return void 0!==h.video?h.video.mediaSource="window":h.video={mediaSource:"window"},void q.apply(navigator,[h,o,r]);var s=a.video.extensionId||"pndohhifhheefbpeljcmnhnkphepimhe";h.audio=!1;try{chrome.runtime.sendMessage(s,{getStream:!0},function(a){return void 0===a?void("function"==typeof b&&b({code:1103,msg:"screen sharing plugin inaccessible"})):(h.video.mandatory.chromeMediaSource="desktop",h.video.mandatory.chromeMediaSourceId=a.streamId,void q.apply(navigator,[h,o,r]))})}catch(t){"function"==typeof b&&b({code:1103,msg:"screen sharing plugin inaccessible",err:t})}}else j()?navigator.getUserMedia(h,o,r):q.apply(navigator,[h,o,r])}function o(a,b){if("object"!=typeof a||!a.url)return void("function"==typeof b&&b({code:1107,msg:"External stream must have url property"}));var c=new d.ExternalStream(a);"function"==typeof b&&b(null,c)}b.prototype.close=function(){"function"==typeof this.hide&&this.hide(),this.mediaStream&&this.mediaStream.getTracks().map(function(a){"function"==typeof a.stop&&a.stop()}),this.mediaStream=null,"function"==typeof this.unpublish&&this.unpublish(),this.channel&&"function"==typeof this.channel.close&&this.channel.close()},b.prototype.createObjectURL=function(){return this.mediaStream?(a.URL||webkitURL).createObjectURL(this.mediaStream):""},b.prototype.disableAudio=function(a){var b=this;if(b.hasAudio()&&b.mediaStream){if(void 0===a&&(a=0),-1===a)return b.mediaStream.getAudioTracks().map(function(a){return a.enabled?(a.enabled=!1,!0):!1});var c=b.mediaStream.getAudioTracks();if(c&&c[a]&&c[a].enabled)return c[a].enabled=!1,!0}return!1},b.prototype.enableAudio=function(a){var b=this;if(b.hasAudio()&&b.mediaStream){if(void 0===a&&(a=0),-1===a)return b.mediaStream.getAudioTracks().map(function(a){return a.enabled!==!0?(a.enabled=!0,!0):!1});var c=b.mediaStream.getAudioTracks();if(c&&c[a]&&c[a].enabled!==!0)return c[a].enabled=!0,!0}return!1},b.prototype.disableVideo=function(a){var b=this;if(b.hasVideo()&&b.mediaStream){if(void 0===a&&(a=0),-1===a)return b.mediaStream.getVideoTracks().map(function(a){return a.enabled?(a.enabled=!1,!0):!1});var c=b.mediaStream.getVideoTracks();if(c&&c[a]&&c[a].enabled)return c[a].enabled=!1,!0}return!1},b.prototype.enableVideo=function(a){var b=this;if(b.hasVideo()&&b.mediaStream){if(void 0===a&&(a=0),-1===a)return b.mediaStream.getVideoTracks().map(function(a){return a.enabled!==!0?(a.enabled=!0,!0):!1});var c=b.mediaStream.getVideoTracks();if(c&&c[a]&&c[a].enabled!==!0)return c[a].enabled=!0,!0}return!1},b.prototype.updateConfiguration=function(a,b){return void 0!==a?this.channel?void this.channel.updateSpec(a,b):"This stream has not been published, ignoring":void 0},c.prototype=Object.create(b.prototype),f.prototype=Object.create(b.prototype),g.prototype=Object.create(f.prototype),h.prototype=Object.create({}),c.prototype.constructor=c,f.prototype.constructor=f,g.prototype.constructor=g,h.prototype.constructor=h;var p={"true":{mandatory:{}},unspecified:{mandatory:{}},sif:m(320,240),vga:m(640,480),hd720p:m(1280,720),hd1080p:m(1920,1080)},q=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;c.create=function(){n.apply(this,arguments)},h.create=function(){o.apply(this,arguments)},d.Stream=b,d.LocalStream=c,d.RemoteStream=f,d.RemoteMixedStream=g,d.ExternalStream=h}(),function(){function b(){var a=arguments[0];if("function"==typeof a){var b=Array.prototype.slice.call(arguments,1);a.apply(null,b)}}function c(a){a.session_id=d.sessionId+=1;var b={};if(b.browser=k(),"mozilla"===b.browser)e.Logger.debug("Firefox Stack"),b=f.FirefoxStack(a);else if("internet-explorer"===b.browser)e.Logger.debug("IE Stack"),b=f.IEStableStack(a);else if("bowser"===b.browser)e.Logger.debug("Bowser Stack"),b=f.BowserStack(a);else{if("chrome-stable"!==b.browser)throw e.Logger.debug("None!"),"WebRTC stack not available";e.Logger.debug("Stable!"),b=f.ChromeStableStack(a)}return b.updateSpec||(b.updateSpec=function(a,b){e.Logger.error("Update Configuration not implemented in this browser"),b&&b("unimplemented")}),b}function g(a){if(!a.video)return new d.RemoteStream(a);switch(a.video.device){case"mcu":return new d.RemoteMixedStream(a);default:return new d.RemoteStream(a)}}function h(a,b,c,d){if(!a||!a.connected)return d("socket not ready");try{a.emit(b,c,function(a,b){return"success"===a?d(null,b):d(b||"response error")})}catch(e){d("socket emit error")}}function i(a,b,c,d,e){if(!a||!a.connected)return e("error","socket not ready");try{a.emit(b,c,d,function(a,b){e(a,b)})}catch(f){e("error","socket emit error")}}function j(a,c,d,e,f){var g={type:"control",payload:{action:c,streamId:d}};h(a,"customMessage",g,function(a,c){return a?b(f,a):void b(e,c)})}d.sessionId=103;var k=function(){var b="none";return null!==a.navigator.userAgent.match("Firefox")?b="mozilla":a.navigator.appVersion.indexOf("Trident")>-1?b="internet-explorer":null!==a.navigator.userAgent.match("Bowser")?b="bowser":null!==a.navigator.userAgent.match("Chrome")?a.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]>=26&&(b="chrome-stable"):null!==a.navigator.userAgent.match("Safari")?b="bowser":null!==a.navigator.userAgent.match("WebKit")&&(b="bowser"),b},l=0,m=1,n=2,o=function(a){this.internalDispatcher=d.EventDispatcher({}),this.spec=a||{},this.remoteStreams={},this.localStreams={},this.state=l};o.prototype=d.EventDispatcher({}),o.prototype.setIceServers=function(){var a=this.spec;return a.userSetIceServers=[],Array.prototype.slice.call(arguments,0).map(function(b){b instanceof Array?b.map(function(b){"object"==typeof b&&null!==b?"string"==typeof b.urls&&""!==b.urls||b.urls instanceof Array?a.userSetIceServers.push(b):"string"==typeof b.url&&""!==b.url&&(b.urls=b.url,delete b.url,a.userSetIceServers.push(b)):"string"==typeof b&&""!==b&&a.userSetIceServers.push({urls:b})}):"object"==typeof b&&null!==b?"string"==typeof b.urls&&""!==b.urls||b.urls instanceof Array?a.userSetIceServers.push(b):"string"==typeof b.url&&""!==b.url&&(b.urls=b.url,delete b.url,a.userSetIceServers.push(b)):"string"==typeof b&&""!==b&&a.userSetIceServers.push({urls:b})}),a.userSetIceServers},o.prototype.getIceServers=function(){return this.spec.userSetIceServers},o.prototype.join=function(a,f,h){var j=this,k=a.secure===!0,o=a.host;if("string"!=typeof o)return b(h,"invalid host");if(-1===o.indexOf("http")&&(o=k?"https://"+o:"http://"+o),j.state!==l)return b(h,"connection state invalid");if(j.on("server-disconnected",function(){j.state=l,j.myId=null;var a,b;for(a in j.remoteStreams)if(j.remoteStreams.hasOwnProperty(a)){b=j.remoteStreams[a],b.close(),delete j.remoteStreams[a];var c=new d.StreamEvent({type:"stream-removed",stream:b});j.dispatchEvent(c)}for(a in j.localStreams)j.localStreams.hasOwnProperty(a)&&(b=j.localStreams[a],b.channel&&"function"==typeof b.channel.close&&b.channel.close(),delete j.localStreams[a]);try{j.socket.disconnect()}catch(e){}}),j.state=m,void 0!==j.socket)j.socket.connect();else{var p=function(a,b){a.channel=c({callback:function(c){i(j.socket,"signaling_message",{streamId:a.id(),peerSocket:b,msg:c})},stunServerUrl:j.connSettings.stun,turnServer:j.connSettings.turn,maxAudioBW:j.connSettings.maxAudioBW,maxVideoBW:j.connSettings.maxVideoBW,limitMaxAudioBW:j.connSettings.maxAudioBW,limitMaxVideoBW:j.connSettings.maxVideoBW}),a.channel.onaddstream=function(b){e.Logger.info("Stream subscribed"),a.mediaStream=b.stream,this.internalDispatcher.dispatchEvent(new d.StreamEvent({type:"p2p-stream-subscribed",stream:a}))}};j.socket=io.connect(o,{reconnect:!1,secure:k,"force new connection":!0}),j.socket.on("add_stream",function(a){if(void 0!==j.remoteStreams[a.id])return void e.Logger.warning("stream already added:",a.id);var b=g({video:a.video,audio:a.audio,id:a.id,from:a.from,attributes:a.attributes}),c=new d.StreamEvent({type:"stream-added",stream:b});j.remoteStreams[a.id]=b,j.dispatchEvent(c)}),j.socket.on("update_stream",function(a){var b=j.remoteStreams[a.id];b&&b.emit(a.event,a.data)}),j.socket.on("remove_stream",function(a){var b=j.remoteStreams[a.id];if(b){b.close(),delete j.remoteStreams[a.id];var c=new d.StreamEvent({type:"stream-removed",stream:b});j.dispatchEvent(c)}}),j.socket.on("signaling_message_erizo",function(a){var b;b=a.peerId?j.remoteStreams[a.peerId]:j.localStreams[a.streamId],b&&b.channel.processSignalingMessage(a.mess)}),j.socket.on("signaling_message_peer",function(a){var b=j.localStreams[a.streamId];b?b.channel[a.peerSocket].processSignalingMessage(a.msg):(b=j.remoteStreams[a.streamId],b.pc||p(b,a.peerSocket),b.channel.processSignalingMessage(a.msg))}),j.socket.on("publish_me",function(a){var b=j.localStreams[a.streamId];void 0===b.channel&&(b.channel={}),b.channel[a.peerSocket]=c({callback:function(b){i(j.socket,"signaling_message",{streamId:a.streamId,peerSocket:a.peerSocket,msg:b})},audio:b.hasAudio(),video:b.hasVideo(),stunServerUrl:j.connSettings.stun,turnServer:j.connSettings.turn}),b.channel[a.peerSocket].oniceconnectionstatechange=function(c){"disconnected"===c&&(b.channel[a.peerSocket].close(),delete b.channel[a.peerSocket])},b.channel[a.peerSocket].addStream(b.mediaStream),b.channel[a.peerSocket].createOffer()}),j.socket.on("add_recorder",function(a){var b=new d.RecorderEvent({type:"recorder-added",id:a.id});j.dispatchEvent(b)}),j.socket.on("reuse_recorder",function(a){var b=new d.RecorderEvent({type:"recorder-continued",id:a.id});j.dispatchEvent(b)}),j.socket.on("remove_recorder",function(a){var b=new d.RecorderEvent({type:"recorder-removed",id:a.id});j.dispatchEvent(b)}),j.socket.on("disconnect",function(){if(j.state!==l){var a=new d.ClientEvent({type:"server-disconnected"});j.dispatchEvent(a)}}),j.socket.on("user_join",function(a){var b=new d.ClientEvent({type:"user-joined",user:a.user});j.dispatchEvent(b)}),j.socket.on("user_leave",function(a){var b=new d.ClientEvent({type:"user-left",user:a.user});j.dispatchEvent(b)}),j.socket.on("custom_message",function(a){var b=new d.MessageEvent({type:"message-received",msg:a});j.dispatchEvent(b)}),j.socket.on("connect_failed",function(a){b(h,a||"connection_failed")}),j.socket.on("error",function(a){b(h,a||"connection_error")}),j.socket.on("connection_failed",function(){if(e.Logger.info("ICE Connection Failed"),j.state!==l){var a=new d.StreamEvent({type:"stream-failed"});j.dispatchEvent(a)}}),j.socket.on("stream-publish",function(a){var b=j.localStreams[a.id];b&&(console.log("Stream published"),j.dispatchEvent(new d.StreamEvent({type:"stream-published",stream:b})))})}try{j.socket.emit("token",a,function(a,c){if("success"===a){j.connSettings={turn:c.turnServer,stun:c.stunServerUrl,defaultVideoBW:c.defaultVideoBW,maxVideoBW:c.maxVideoBW},j.myId=c.clientId,j.conferenceId=c.id,j.p2p=c.p2p,j.state=n;var d=[];return j.conferenceId=c.id,j.p2p=c.p2p,void 0!==c.streams&&(d=c.streams.map(function(a){return j.remoteStreams[a.id]=g(a),j.remoteStreams[a.id]})),b(f,{streams:d,users:c.users})}return b(h,c||"response error")})}catch(q){b(h,"socket emit error")}},o.prototype.publish=function(a,f,g,k){var l=this;if(a=a||{},"function"==typeof f?(k=g,g=f,f=a.bitRate):"object"==typeof f&&null!==f||(f=a.bitRate),!(a instanceof d.LocalStream||a instanceof d.ExternalStream)||("object"!=typeof a.mediaStream||null===a.mediaStream)&&void 0===a.url())return b(k,"invalid stream");if(void 0!==l.localStreams[a.id()])return b(k,"already published");var m=a.toJson();return f.unmix===!0&&(m.unmix=!0),void 0!==a.url()?(m.state="url",m.transport=f.transport,m.bufferSize=f.bufferSize,void i(l.socket,"publish",m,a.url(),function(c,d){return"success"!==c?b(k,c):(a.id=function(){return d},a.unpublish=function(b,c){l.unpublish(a,b,c)},l.localStreams[d]=a,void b(g,a))})):l.p2p?(l.connSettings.maxVideoBW=f.maxVideoBW,l.connSettings.maxAudioBW=f.maxAudioBW,m.state="p2p",void i(l.socket,"publish",m,null,function(c){return"error"===c?b(k,c):(a.id=function(){return c},a.unpublish=function(b,c){l.unpublish(a,b,c)},l.localStreams[c]=a,void b(g,a))})):(f.maxVideoBW=f.maxVideoBW||l.connSettings.defaultVideoBW,f.maxVideoBW>l.connSettings.maxVideoBW&&(f.maxVideoBW=l.connSettings.maxVideoBW),m.state="erizo",void i(l.socket,"publish",m,void 0,function(d,m){if("error"===d)return b(k,m);if("timeout"===d)return b(k,d);a.id=function(){return m},l.localStreams[m]=a,a.channel=c({callback:function(a){console.log("Sending message",a),i(l.socket,"signaling_message",{streamId:m,msg:a},void 0,function(){})},video:a.hasVideo(),audio:a.hasAudio(),iceServers:l.getIceServers(),stunServerUrl:l.connSettings.stun,turnServer:l.connSettings.turn,maxAudioBW:f.maxAudioBW,maxVideoBW:f.maxVideoBW,limitMaxAudioBW:l.connSettings.maxAudioBW,limitMaxVideoBW:l.connSettings.maxVideoBW,videoCodec:f.videoCodec});var n=function(){a.signalOnPlayAudio=function(a,b){j(l.socket,"audio-out-on",m,a,b)},a.signalOnPauseAudio=function(a,b){j(l.socket,"audio-out-off",m,a,b)},a.signalOnPlayVideo=function(a,b){j(l.socket,"video-out-on",m,a,b)},a.signalOnPauseVideo=function(a,b){j(l.socket,"video-out-off",m,a,b)},a.unpublish=function(b,c){l.unpublish(a,b,c)},b(g,a),n=function(){},o=function(){}},o=function(){h(l.socket,"unpublish",m,function(){},function(){}),a.channel.close(),a.channel=void 0,b(k,"peer connection failed"),n=function(){},o=function(){}};a.channel.oniceconnectionstatechange=function(a){switch(a){case"completed":case"connected":n();break;case"checking":case"closed":break;case"failed":o();break;default:e.Logger.warning("unknown ice connection state:",a)}},a.channel.addStream(a.mediaStream),a.channel.createOffer()}))},o.prototype.unpublish=function(a,c,e){var f=this;return a instanceof d.LocalStream||a instanceof d.ExternalStream?void h(f.socket,"unpublish",a.id(),function(d){return d?b(e,d):(a.channel&&"function"==typeof a.channel.close&&(a.channel.close(),a.channel=null),delete f.localStreams[a.id()],a.id=function(){return null},a.signalOnPlayAudio=void 0,a.signalOnPauseAudio=void 0,a.signalOnPlayVideo=void 0,a.signalOnPauseVideo=void 0,delete a.unpublish,void b(c,null))}):b(e,"invalid stream")},o.prototype.subscribe=function(a,f,g,l){var m=this,n=!1,o=!1;return"function"==typeof f?(l=g,g=f,f={}):"object"==typeof f&&null!==f||(f={}),a instanceof d.RemoteStream?m.p2p?(this.internalDispatcher.on("p2p-stream-subscribed",function p(a){this.internalDispatcher.removeEventListener("p2p-stream-subscribed",p),b(g,a.stream)}),void i(m.socket,"subscribe",{streamId:a.id()},null,function(){})):f.audio===!1&&f.video===!1?b(l,"no audio or video to subscribe."):void i(m.socket,"subscribe",{streamId:a.id(),audio:a.hasAudio()&&f.audio!==!1,video:a.hasVideo()&&f.video,browser:k()},void 0,function(d,k){if("error"===d||"timeout"===d)return b(l,k||d);a.channel=c({callback:function(b){i(m.socket,"signaling_message",{streamId:a.id(),msg:b,browser:a.channel.browser},void 0,function(){})},audio:a.hasAudio()&&f.audio!==!1,video:a.hasVideo()&&f.video!==!1,iceServers:m.getIceServers(),stunServerUrl:m.connSettings.stun,turnServer:m.connSettings.turn,videoCodec:f.videoCodec}),a.channel.onaddstream=function(c){a.mediaStream=c.stream,navigator.appVersion.indexOf("Trident")>-1&&(a.pcid=c.pcid),o&&n===!1?(n=!0,b(g,a)):n=!0};var p=function(){a.signalOnPlayAudio=function(b,c){j(m.socket,"audio-in-on",a.id(),b,c)},a.signalOnPauseAudio=function(b,c){j(m.socket,"audio-in-off",a.id(),b,c)},a.signalOnPlayVideo=function(b,c){j(m.socket,"video-in-on",a.id(),b,c)},a.signalOnPauseVideo=function(b,c){j(m.socket,"video-in-off",a.id(),b,c)},n&&o===!1?(o=!0,b(g,a)):o=!0,p=function(){},q=function(){}},q=function(){h(m.socket,"unsubscribe",a.id(),function(){},function(){}),a.close(),a.signalOnPlayAudio=void 0,a.signalOnPauseAudio=void 0,a.signalOnPlayVideo=void 0,a.signalOnPauseVideo=void 0,b(l,"peer connection failed"),p=function(){},q=function(){}};a.channel.oniceconnectionstatechange=function(a){switch(a){case"completed":case"connected":p();break;case"checking":case"closed":break;case"failed":q();break;default:e.Logger.warning("unknown ice connection state:",a)}},a.channel.createOffer(!0)}):b(l,"invalid stream")},o.prototype.unsubscribe=function(a,c,e){
var f=this;return a instanceof d.RemoteStream?void h(f.socket,"unsubscribe",a.id(),function(d,f){return d?b(e,d):(a.close(),a.signalOnPlayAudio=void 0,a.signalOnPauseAudio=void 0,a.signalOnPlayVideo=void 0,a.signalOnPauseVideo=void 0,void b(c,f))}):b(e,"invalid stream")},o.prototype.onMessage=function(a){"function"==typeof a&&this.on("message-received",a)},d.ConferenceClient=function(){"use strict";var a=function(a){o.call(this,a),this.join=function(a,c,d){try{a=JSON.parse(e.Base64.decodeBase64(a))}catch(f){return b(d,"invalid token")}o.prototype.join.call(this,a,c,d)},this.leave=function(){var a=new d.ClientEvent({type:"server-disconnected"});this.dispatchEvent(a)},this.send=function(a,c,d,e){if(void 0===a||null===a||"function"==typeof a)return b(e,"nothing to send");if("undefined"==typeof c)c="all";else if("string"==typeof c);else{if("function"!=typeof c)return b(e,"invalid receiver");e=d,d=c,c="all"}h(this.socket,"customMessage",{type:"data",data:a,receiver:c},function(a,c){return a?b(e,a):void b(d,c)})},this.mix=function(a,c,e){return a instanceof d.LocalStream?void h(this.socket,"addToMixer",a.id(),function(a){return a?b(e,a):void b(c,null)}):b(e,"invalid stream")},this.unmix=function(a,c,e){return a instanceof d.LocalStream?void h(this.socket,"removeFromMixer",a.id(),function(a){return a?b(e,a):void b(c,null)}):b(e,"invalid stream")},this.shareScreen=function(a,c,e){var f=this;"function"==typeof a&&(e=c,c=a,a={}),a=a||{},d.LocalStream.create({video:{device:"screen",extensionId:a.extensionId,resolution:a.resolution?a.resolution:{width:screen.width,height:screen.height},frameRate:a.frameRate},audio:!1},function(d,g){return d?b(e,d):void f.publish(g,{maxVideoBW:a.maxVideoBW,videoCodec:a.videoCodec},function(a){b(c,a)},function(a){b(e,a)})})},this.playAudio=function(a,b,c){return a instanceof d.Stream&&a.hasAudio()&&"function"==typeof a.signalOnPlayAudio?a.signalOnPlayAudio(b,c):void("function"==typeof c&&c("unable to call playAudio"))},this.pauseAudio=function(a,b,c){return a instanceof d.Stream&&a.hasAudio()&&"function"==typeof a.signalOnPauseAudio?a.signalOnPauseAudio(b,c):void("function"==typeof c&&c("unable to call pauseAudio"))},this.playVideo=function(a,b,c){return a instanceof d.Stream&&a.hasVideo()&&"function"==typeof a.signalOnPlayVideo?a.signalOnPlayVideo(b,c):void("function"==typeof c&&c("unable to call playVideo"))},this.pauseVideo=function(a,b,c){return a instanceof d.Stream&&a.hasVideo()&&"function"==typeof a.signalOnPauseVideo?a.signalOnPauseVideo(b,c):void("function"==typeof c&&c("unable to call pauseVideo"))},this.startRecorder=function(a,c,d){var e=this;"function"==typeof a?(d=c,c=a,a={}):"object"==typeof a&&null!==a||(a={}),h(e.socket,"startRecorder",a,function(a,e){return a?b(d,a):void b(c,e)})},this.stopRecorder=function(a,c,d){var e=this;"function"==typeof a?(d=c,c=a,a={}):"object"==typeof a&&null!==a||(a={}),h(e.socket,"stopRecorder",a,function(a,e){return a?b(d,a):void b(c,e)})},this.getRegion=function(a,c,d){var e=this;return"object"!=typeof a||null===a||"string"!=typeof a.id||""===a.id?b(d,"invalid options"):void h(e.socket,"getRegion",{id:a.id},function(a,e){return a?b(d,a):void b(c,e)})},this.setRegion=function(a,c,d){var e=this;return"object"!=typeof a||null===a||"string"!=typeof a.id||""===a.id||"string"!=typeof a.region||""===a.region?b(d,"invalid options"):void h(e.socket,"setRegion",{id:a.id,region:a.region},function(a,e){return a?b(d,a):void b(c,e)})},this.setVideoBitrate=function(a,c,d){var e=this;"function"==typeof a?(d=c,c=a,a={}):"object"==typeof a&&null!==a||(a={}),h(e.socket,"setVideoBitrate",a,function(a,e){return a?b(d,a):void b(c,e)})}};return a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.create=function(b){return new a(b)},a}(),d.SipClient=function(){var a=function(a){o.call(this,a),this.sip=!0,this.join=function(a,b,c){a.host=this.spec.host,a.secure=this.spec.secure,o.prototype.join.call(this,a,b,c)},this.subscribe=function(a,b,c,e){var f=this;"function"==typeof b?(e=c,c=b,b={}):"object"==typeof b&&null!==b||(b={});var g=function(a){f.dispatchEvent(new d.StreamEvent({type:"stream-subscribed",stream:a})),c(a)};o.prototype.subscribe.call(this,a,b,g,e)},this.acceptCall=function(a,c){var d=this,e={type:"acceptCall"};h(d.socket,"customMessage",e,function(d,e){return d?b(c,d):void b(a,e)})},this.rejectCall=function(a,c){var d=this,e={type:"rejectCall"};h(d.socket,"customMessage",e,function(d,e){return d?b(c,d):void b(a,e)})},this.hangupCall=function(a,c){var d=this,e={type:"hangupCall"};h(d.socket,"customMessage",e,function(d,e){return d?b(c,d):void b(a,e)})},this.makeCall=function(a,c,d){var e=this,f={type:"makeCall",payload:a};h(e.socket,"customMessage",f,function(a,e){return a?b(d,a):void b(c,e)})}};return a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.create=function(b){return new a(b)},a}()}(),f.ChromeStableStack=function(a){"use strict";var b={},c=webkitRTCPeerConnection;b.pc_config={iceServers:[]},b.con={optional:[{DtlsSrtpKeyAgreement:!0}]},a.iceServers instanceof Array?b.pc_config.iceServers=a.iceServers:(a.stunServerUrl&&(a.stunServerUrl instanceof Array?a.stunServerUrl.map(function(a){"string"==typeof a&&""!==a&&b.pc_config.iceServers.push({urls:a})}):"string"==typeof a.stunServerUrl&&""!==a.stunServerUrl&&b.pc_config.iceServers.push({urls:a.stunServerUrl})),a.turnServer&&(a.turnServer instanceof Array?a.turnServer.map(function(a){"string"==typeof a.url&&""!==a.url&&b.pc_config.iceServers.push({username:a.username,credential:a.password,urls:a.url})}):"string"==typeof a.turnServer.url&&""!==a.turnServer.url&&b.pc_config.iceServers.push({username:a.turnServer.username,credential:a.turnServer.password,urls:a.turnServer.url}))),void 0===a.audio&&(a.audio=!0),void 0===a.video&&(a.video=!0),b.mediaConstraints={mandatory:{OfferToReceiveVideo:a.video,OfferToReceiveAudio:a.audio}};var d=function(a){console.log("Error in Stack ",a)};b.peerConnection=new c(b.pc_config,b.con);var f=function(b){var c,d;return a.video&&a.maxVideoBW&&(b=b.replace(/b=AS:.*\r\n/g,""),c=b.match(/m=video.*\r\n/),null==c&&(c=b.match(/m=video.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxVideoBW+"\r\n",b=b.replace(c[0],d))),a.audio&&a.maxAudioBW&&(c=b.match(/m=audio.*\r\n/),null==c&&(c=b.match(/m=audio.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxAudioBW+"\r\n",b=b.replace(c[0],d))),b};b.close=function(){b.state="closed","closed"!==b.peerConnection.signalingState&&b.peerConnection.close()},a.localCandidates=[],b.peerConnection.onicecandidate=function(b){if(b.candidate){b.candidate.candidate.match(/a=/)||(b.candidate.candidate="a="+b.candidate.candidate);var c={sdpMLineIndex:b.candidate.sdpMLineIndex,sdpMid:b.candidate.sdpMid,candidate:b.candidate.candidate};a.remoteDescriptionSet?a.callback({type:"candidate",candidate:c}):(a.localCandidates.push(c),e.Logger.info("Storing candidate: ",a.localCandidates.length,c))}else console.log("End of candidates.")},b.peerConnection.onaddstream=function(a){b.onaddstream&&b.onaddstream(a)},b.peerConnection.onremovestream=function(a){b.onremovestream&&b.onremovestream(a)},b.peerConnection.oniceconnectionstatechange=function(a){b.oniceconnectionstatechange&&b.oniceconnectionstatechange(a.currentTarget.iceConnectionState)};var g,h,i=function(b){b.sdp=f(b.sdp),b.sdp=b.sdp.replace(/a=ice-options:google-ice\r\n/g,""),a.callback({type:b.type,sdp:b.sdp}),g=b},j=function(c){c.sdp=f(c.sdp),a.callback({type:c.type,sdp:c.sdp}),g=c,b.peerConnection.setLocalDescription(c)};return b.updateSpec=function(c,d){(c.maxVideoBW||c.maxAudioBW)&&(c.maxVideoBW&&(console.log("Maxvideo Requested",c.maxVideoBW,"limit",a.limitMaxVideoBW),c.maxVideoBW>a.limitMaxVideoBW&&(c.maxVideoBW=a.limitMaxVideoBW),a.maxVideoBW=c.maxVideoBW,console.log("Result",a.maxVideoBW)),c.maxAudioBW&&(c.maxAudioBW>a.limitMaxAudioBW&&(c.maxAudioBW=a.limitMaxAudioBW),a.maxAudioBW=c.maxAudioBW),g.sdp=f(g.sdp),b.peerConnection.setLocalDescription(g,function(){h.sdp=f(h.sdp),b.peerConnection.setRemoteDescription(new RTCSessionDescription(h),function(){a.remoteDescriptionSet=!0,d&&d("success")})}))},b.createOffer=function(a){a===!0?b.peerConnection.createOffer(i,d,b.mediaConstraints):b.peerConnection.createOffer(i,d)},b.addStream=function(a){b.peerConnection.addStream(a)},a.remoteCandidates=[],a.remoteDescriptionSet=!1,b.processSignalingMessage=function(c){if("offer"===c.type)c.sdp=f(c.sdp),b.peerConnection.setRemoteDescription(new RTCSessionDescription(c),function(){b.peerConnection.createAnswer(j,function(a){e.Logger.error("Error: ",a)},b.mediaConstraints),a.remoteDescriptionSet=!0},function(a){e.Logger.error("Error setting Remote Description",a)});else if("answer"===c.type)console.log("Set remote and local description",c.sdp),c.sdp=f(c.sdp),h=c,b.peerConnection.setLocalDescription(g,function(){b.peerConnection.setRemoteDescription(new RTCSessionDescription(c),function(){for(a.remoteDescriptionSet=!0,console.log("Candidates to be added: ",a.remoteCandidates.length,a.remoteCandidates);a.remoteCandidates.length>0;)b.peerConnection.addIceCandidate(a.remoteCandidates.shift());for(console.log("Local candidates to send:",a.localCandidates.length);a.localCandidates.length>0;)a.callback({type:"candidate",candidate:a.localCandidates.shift()})})});else if("candidate"===c.type)try{var d;d="object"==typeof c.candidate?c.candidate:JSON.parse(c.candidate),d.candidate=d.candidate.replace(/a=/g,""),d.sdpMLineIndex=parseInt(d.sdpMLineIndex,10);var i=new RTCIceCandidate(d);a.remoteDescriptionSet?b.peerConnection.addIceCandidate(i):(a.remoteCandidates.push(i),console.log("Candidates stored: ",a.remoteCandidates.length,a.remoteCandidates))}catch(k){e.Logger.error("Error parsing candidate",c.candidate)}},b},f.FirefoxStack=function(a){"use strict";var b={},c=mozRTCPeerConnection,d=mozRTCSessionDescription,f=mozRTCIceCandidate;b.pc_config={iceServers:[]},a.iceServers instanceof Array?b.pc_config.iceServers=a.iceServers:(a.stunServerUrl&&(a.stunServerUrl instanceof Array?a.stunServerUrl.map(function(a){"string"==typeof a&&""!==a&&b.pc_config.iceServers.push({urls:a})}):"string"==typeof a.stunServerUrl&&""!==a.stunServerUrl&&b.pc_config.iceServers.push({urls:a.stunServerUrl})),a.turnServer&&(a.turnServer instanceof Array?a.turnServer.map(function(a){"string"==typeof a.url&&""!==a.url&&b.pc_config.iceServers.push({username:a.username,credential:a.password,urls:a.url})}):"string"==typeof a.turnServer.url&&""!==a.turnServer.url&&b.pc_config.iceServers.push({username:a.turnServer.username,credential:a.turnServer.password,urls:a.turnServer.url}))),void 0===a.audio&&(a.audio=!0),void 0===a.video&&(a.video=!0),b.mediaConstraints={offerToReceiveAudio:a.audio,offerToReceiveVideo:a.video,mozDontOfferDataChannel:!0};var g=function(a){e.Logger.error("Error in Stack ",a)},h=!1;b.peerConnection=new c(b.pc_config),a.localCandidates=[],b.peerConnection.onicecandidate=function(b){b.candidate?(h=!0,b.candidate.candidate.match(/a=/)||(b.candidate.candidate="a="+b.candidate.candidate),a.remoteDescriptionSet?a.callback({type:"candidate",candidate:b.candidate}):(a.localCandidates.push(b.candidate),console.log("Local Candidates stored: ",a.localCandidates.length,a.localCandidates))):console.log("End of candidates.")};var i=function(b){if("H264"!==a.videoCodec&&"h264"!==a.videoCodec)return b;try{var c=b.match(/m=video.*\r\n/g)[0],d=c.replace(/\s120/,"").replace("\r\n","")+" 120\r\n";return b.replace(c,d)}catch(e){return b}},j=function(a){var b=i(a);return b};b.peerConnection.onaddstream=function(a){b.onaddstream&&b.onaddstream(a)},b.peerConnection.onremovestream=function(a){b.onremovestream&&b.onremovestream(a)},b.peerConnection.oniceconnectionstatechange=function(a){b.oniceconnectionstatechange&&b.oniceconnectionstatechange(a.currentTarget.iceConnectionState)};var k,l=function(b){var c,d;return a.video&&a.maxVideoBW&&(c=b.match(/m=video.*\r\n/),null==c&&(c=b.match(/m=video.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxVideoBW+"\r\n",b=b.replace(c[0],d))),a.audio&&a.maxAudioBW&&(c=b.match(/m=audio.*\r\n/),null==c&&(c=b.match(/m=audio.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxAudioBW+"\r\n",b=b.replace(c[0],d))),b},m=function(b){b.sdp=l(b.sdp),b.sdp=j(b.sdp.replace(/a=ice-options:google-ice\r\n/g,"")),a.callback(b),k=b},n=function(c){c.sdp=l(c.sdp),c.sdp=c.sdp.replace(/a=ice-options:google-ice\r\n/g,""),a.callback(c),k=c,b.peerConnection.setLocalDescription(k)};return b.createOffer=function(a){a===!0?b.peerConnection.createOffer(m,g,b.mediaConstraints):b.peerConnection.createOffer(m,g)},b.addStream=function(a){b.peerConnection.addStream(a)},a.remoteCandidates=[],a.remoteDescriptionSet=!1,b.close=function(){b.state="closed","closed"!==b.peerConnection.signalingState&&b.peerConnection.close()},b.processSignalingMessage=function(c){if("offer"===c.type)c.sdp=l(c.sdp),b.peerConnection.setRemoteDescription(new d(c),function(){b.peerConnection.createAnswer(n,function(a){e.Logger.error("Error",a)},b.mediaConstraints),a.remoteDescriptionSet=!0},function(a){e.Logger.error("Error setting Remote Description",a)});else if("answer"===c.type)console.log("Set remote and local description",c.sdp),c.sdp=l(c.sdp),b.peerConnection.setLocalDescription(k,function(){b.peerConnection.setRemoteDescription(new d(c),function(){for(a.remoteDescriptionSet=!0,e.Logger.info("Remote Description successfully set");a.remoteCandidates.length>0&&h;)e.Logger.info("Setting stored remote candidates"),b.peerConnection.addIceCandidate(a.remoteCandidates.shift());for(;a.localCandidates.length>0;)e.Logger.info("Sending Candidate from list"),a.callback({type:"candidate",candidate:a.localCandidates.shift()})},function(a){e.Logger.error("Error Setting Remote Description",a)})},function(a){e.Logger.error("Failure setting Local Description",a)});else if("candidate"===c.type)try{var g;g="object"==typeof c.candidate?c.candidate:JSON.parse(c.candidate),g.candidate=g.candidate.replace(/ generation 0/g,""),g.candidate=g.candidate.replace(/ udp /g," UDP "),g.sdpMLineIndex=parseInt(g.sdpMLineIndex,10);var i=new f(g);if(a.remoteDescriptionSet&&h)for(b.peerConnection.addIceCandidate(i);a.remoteCandidates.length>0;)e.Logger.info("Setting stored remote candidates"),b.peerConnection.addIceCandidate(a.remoteCandidates.shift());else a.remoteCandidates.push(i)}catch(j){e.Logger.error("Error parsing candidate",c.candidate,j)}},b},f.IEStableStack=function(a){"use strict";var b=function(a,b,c){this.candidate=a,this.sdpMid=b,this.sdpMLineIndex=c},c=function(a){this.type=a.type,this.sdp=a.sdp},f=d.ieplugin.ieRTCPeerConnection,g=c,h={},i=f;h.pc_config={iceServers:[]},a.iceServers instanceof Array?h.pc_config.iceServers=a.iceServers:(a.stunServerUrl&&(a.stunServerUrl instanceof Array?a.stunServerUrl.map(function(a){"string"==typeof a&&""!==a&&h.pc_config.iceServers.push({urls:a})}):"string"==typeof a.stunServerUrl&&""!==a.stunServerUrl&&h.pc_config.iceServers.push({urls:a.stunServerUrl})),a.turnServer&&(a.turnServer instanceof Array?a.turnServer.map(function(a){"string"==typeof a.url&&""!==a.url&&h.pc_config.iceServers.push({username:a.username,credential:a.password,urls:a.url})}):"string"==typeof a.turnServer.url&&""!==a.turnServer.url&&h.pc_config.iceServers.push({username:a.turnServer.username,credential:a.turnServer.password,urls:a.turnServer.url}))),void 0===a.audio&&(a.audio=!0),void 0===a.video&&(a.video=!0),h.mediaConstraints={mandatory:{OfferToReceiveVideo:a.video,OfferToReceiveAudio:a.audio}};var j=function(a){console.log("Error in Stack ",a)};h.peerConnection=new i(h.pc_config);var k=function(b){var c,d;return a.video&&a.maxVideoBW&&(b=b.replace(/b=AS:.*\r\n/g,""),c=b.match(/m=video.*\r\n/),null==c&&(c=b.match(/m=video.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxVideoBW+"\r\n",b=b.replace(c[0],d))),a.audio&&a.maxAudioBW&&(c=b.match(/m=audio.*\r\n/),null==c&&(c=b.match(/m=audio.*\n/)),c&&c.length>0&&(d=c[0]+"b=AS:"+a.maxAudioBW+"\r\n",b=b.replace(c[0],d))),b};h.close=function(){h.state="closed","closed"!==h.peerConnection.signalingState&&h.peerConnection.close()},a.localCandidates=[],h.peerConnection.onicecandidate=function(b){if(b.candidate){b.candidate.candidate.match(/a=/)||(b.candidate.candidate="a="+b.candidate.candidate);var c={sdpMLineIndex:b.candidate.sdpMLineIndex,sdpMid:b.candidate.sdpMid,candidate:b.candidate.candidate};a.remoteDescriptionSet?a.callback({type:"candidate",candidate:c}):(a.localCandidates.push(c),e.Logger.info("Storing candidate: ",a.localCandidates.length,c))}else console.log("End of candidates.")},h.peerConnection.onaddstream=function(a){h.onaddstream&&h.onaddstream(a)},h.peerConnection.onremovestream=function(a){h.onremovestream&&h.onremovestream(a)},h.peerConnection.oniceconnectionstatechange=function(a){h.oniceconnectionstatechange&&h.oniceconnectionstatechange(a)};var l,m,n=function(b){b.sdp=k(b.sdp),b.sdp=b.sdp.replace(/a=ice-options:google-ice\r\n/g,""),a.callback({type:b.type,sdp:b.sdp}),l=b},o=function(b){b.sdp=k(b.sdp),a.callback({type:b.type,sdp:b.sdp}),l=b,h.peerConnection.setLocalDescription(b)};return h.updateSpec=function(b,c){(b.maxVideoBW||b.maxAudioBW)&&(b.maxVideoBW&&(console.log("Maxvideo Requested",b.maxVideoBW,"limit",a.limitMaxVideoBW),b.maxVideoBW>a.limitMaxVideoBW&&(b.maxVideoBW=a.limitMaxVideoBW),a.maxVideoBW=b.maxVideoBW,console.log("Result",a.maxVideoBW)),b.maxAudioBW&&(b.maxAudioBW>a.limitMaxAudioBW&&(b.maxAudioBW=a.limitMaxAudioBW),a.maxAudioBW=b.maxAudioBW),l.sdp=k(l.sdp),h.peerConnection.setLocalDescription(l,function(){m.sdp=k(m.sdp),h.peerConnection.setRemoteDescription(new g(m),function(){a.remoteDescriptionSet=!0,c&&c("success")})}))},h.createOffer=function(a){a===!0?h.peerConnection.createOffer(n,j,h.mediaConstraints):h.peerConnection.createOffer(n,j)},h.addStream=function(a){h.peerConnection.addStream(a)},a.remoteCandidates=[],a.remoteDescriptionSet=!1,h.processSignalingMessage=function(c){if("offer"===c.type)c.sdp=k(c.sdp),h.peerConnection.setRemoteDescription(new g(c),function(){h.peerConnection.createAnswer(o,function(a){e.Logger.error("Error: ",a)},h.mediaConstraints),a.remoteDescriptionSet=!0},function(a){e.Logger.error("Error setting Remote Description",a)});else if("answer"===c.type)console.log("Set remote and local description",c.sdp),c.sdp=k(c.sdp),m=c,h.peerConnection.setLocalDescription(l,function(){h.peerConnection.setRemoteDescription(new g(c),function(){for(a.remoteDescriptionSet=!0,console.log("Candidates to be added: ",a.remoteCandidates.length,a.remoteCandidates);a.remoteCandidates.length>0;)h.peerConnection.addIceCandidate(a.remoteCandidates.shift());for(console.log("Local candidates to send:",a.localCandidates.length);a.localCandidates.length>0;)a.callback({type:"candidate",candidate:a.localCandidates.shift()})})});else if("candidate"===c.type)try{var d;d="object"==typeof c.candidate?c.candidate:JSON.parse(c.candidate),d.candidate=d.candidate.replace(/a=/g,""),d.sdpMLineIndex=parseInt(d.sdpMLineIndex,10);var f=new b(d);a.remoteDescriptionSet?h.peerConnection.addIceCandidate(f):(a.remoteCandidates.push(f),console.log("Candidates stored: ",a.remoteCandidates.length,a.remoteCandidates))}catch(i){e.Logger.error("Error parsing candidate",c.candidate)}},h};var d=d||{};d.Error={STREAM_LOCAL_ACCESS_DENIED:{code:1101,message:"Cannot access to camera or micphone."},P2P_CONN_SERVER_UNKNOWN:{code:2100,message:"Server unknown error."},P2P_CONN_SERVER_UNAVAILABLE:{code:2101,message:"Server is unavaliable."},P2P_CONN_SERVER_BUSY:{code:2102,message:"Server is too busy."},P2P_CONN_SERVER_NOT_SUPPORTED:{code:2103,message:"Method has not been supported by server"},P2P_CONN_CLIENT_UNKNOWN:{code:2110,message:"Client unknown error."},P2P_CONN_CLIENT_NOT_INITIALIZED:{code:2111,message:"Connection is not initialized."},P2P_CONN_AUTH_UNKNOWN:{code:2120,message:"Authentication unknown error."},P2P_CONN_AUTH_FAILED:{code:2121,message:"Wrong username or token."},P2P_MESSAGING_TARGET_UNREACHABLE:{code:2201,message:"Remote user cannot be reached."},P2P_CHATROOM_ATTENDEE_EXCEED:{code:2301,message:"Exceed room's limitation"},P2P_CHATROOM_PEER_NOT_FOUND:{code:2302,message:"Peer not found. Only one client in the room."},P2P_CLIENT_UNKNOWN:{code:2400,message:"Unknown errors."},P2P_CLIENT_UNSUPPORTED_METHOD:{code:2401,message:"This method is unsupported in current browser."},P2P_CLIENT_ILLEGAL_ARGUMENT:{code:2402,message:"Illegal argument."},P2P_CLIENT_INVALID_STATE:{code:2403,message:"Invalid peer state."},getErrorByCode:function(a){var b={1101:d.Error.STREAM_LOCAL_ACCESS_DENIED,2100:d.Error.P2P_CONN_SERVER_UNKNOWN,2101:d.Error.P2P_CONN_SERVER_UNAVAILABLE,2102:d.Error.P2P_CONN_SERVER_BUSY,2103:d.Error.P2P_CONN_SERVER_NOT_SUPPORTED,2110:d.Error.P2P_CONN_CLIENT_UNKNOWN,2111:d.Error.P2P_CONN_CLIENT_NOT_INITIALIZED,2120:d.Error.P2P_CONN_AUTH_UNKNOWN,2121:d.Error.P2P_CONN_AUTH_FAILED,2201:d.Error.P2P_MESSAGING_TARGET_UNREACHABLE,2301:d.Error.P2P_CHATROOM_ATTENDEE_EXCEED,2302:d.Error.P2P_CHATROOM_PEER_NOT_FOUND,2400:d.Error.P2P_CLIENT_UNKNOWN,2401:d.Error.P2P_CLIENT_UNSUPPORTED_METHOD,2402:d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT,2403:d.Error.P2P_CLIENT_INVALID_STATE};return b[a]}};var d=d||{};d.PeerClient=function(a){"use strict";var b,f,g=d.EventDispatcher({}),h={READY:1,MATCHED:2,OFFERED:3,PENDING:4,CONNECTING:5,CONNECTED:6,ERROR:9},i={READY:1,REQUESTED:2,ACCEPTED:3,NEGOTIATING:4},j={MESSAGE:"message",FILE:"file"},k=a?a.bandWidth:void 0,l=function(a){return"[object Array]"===Object.prototype.toString.call(a)},m=15e3,n=null,o={},p={},q=null,r=!1,s={},t={optional:[{DtlsSrtpKeyAgreement:"true"}]},u=null,v=null;navigator.mozGetUserMedia||(v={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}});var w=null,x=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];if(l(d.urls))for(var e=0;e<d.urls.length;e++)b.push({url:d.urls[e],username:d.username,credential:d.credential});else b.push({url:d.urls,username:d.username,credential:d.credential})}return b};a&&(w={},a.iceServers&&(w.iceServers=x(a.iceServers)));var y=function(a,b){return a.localeCompare(b)},z=function(a){return a},A=function(a,b){a.negotiationState=b},B=function(a,b){a.state!==h.CONNECTED&&a.state!==h.CONNECTING||(a.sendDataChannel&&a.sendDataChannel.close(),a.receiveDataChannel&&a.receiveDataChannel.close(),a.connection&&"closed"!==a.connection.iceConnectionState&&a.connection.close(),a.state!==h.READY&&(a.state=h.READY,g.dispatchEvent(new d.ChatEvent({type:"chat-stopped",peerId:a.id,senderId:b}))),_(a.connection))},C=function(){r=!0},D=function(){f&&f(),b=void 0,f=void 0},E=function(){r=!1,g.dispatchEvent(new d.ClientEvent({type:"server-disconnected"}))},F=function(a){var b=o[a];b||(ea(a),b=o[a]),b.state===h.READY||b.state===h.PENDING?(o[a].state=h.PENDING,g.dispatchEvent(new d.ChatEvent({type:"chat-invited",senderId:a}))):b.state===h.OFFERED&&y(q,a)<0&&(b.state=h.PENDING,la(a,function(){g.dispatchEvent(new d.ChatEvent({type:"chat-accepted",senderId:a}))}))},G=function(a){var b=o[a];b&&b.connection&&(b.sendDataChannel&&b.sendDataChannel.close(),b.receiveDataChannel&&b.receiveDataChannel.close(),b.connection.close()),delete o[a],g.dispatchEvent(new d.ChatEvent({type:"chat-denied",senderId:a}))},H=function(a){e.Logger.debug("Received chat accepted.");var b=o[a];b&&(b.state=h.MATCHED,$(b),b.state=h.CONNECTING,na(b),g.dispatchEvent(new d.ChatEvent({type:"chat-accepted",senderId:a})))},I=function(a){var b=o[a];b&&b.connection&&B(b,a),delete o[a]},J=function(a,b){var c=o[b];c&&c.state===h.CONNECTING&&(c.connection||$(c)),V(c,a)},K=function(a,b){p[a.streamId]=a.type,e.Logger.debug("remote stream ID:"+a.streamId+",type:"+p[a.streamId])},L=function(a){q=a,b&&b(a),b=void 0,f=void 0},M=function(){za()},N=function(a){e.Logger.debug("On negotiation needed."),n&&(n.sendNegotiationNeeded(a.id),A(a,i.REQUESTED))},O=function(a,b){b.candidate&&n&&n.sendSignalMessage(a.id,{type:"candidates",candidate:b.candidate.candidate,sdpMid:b.candidate.sdpMid,sdpMLineIndex:b.candidate.sdpMLineIndex})},P=function(a,b){if(a&&e.Logger.debug("On remote ice candidate from peer "+a.id),a&&(a.state===h.OFFERED||a.state===h.CONNECTING||a.state===h.CONNECTED)){var c=new RTCIceCandidate({candidate:b.message.candidate,sdpMid:b.message.sdpMid,sdpMLineIndex:b.message.sdpMLineIndex});a.connection?(e.Logger.debug("Add remote ice candidates."),a.connection.addIceCandidate(c,X,Y)):(e.Logger.debug("Cache remote ice candidates."),a.remoteIceCandidates||(a.remoteIceCandidates=[]),a.remoteIceCandidates.push(c))}},Q=function(a,b){if(!a)return void e.Logger.debug('"peer" cannot be null or undefined');switch(a.state){case h.OFFERED:case h.MATCHED:a.state=h.CONNECTING,$(a);case h.CONNECTING:case h.CONNECTED:e.Logger.debug("About to set remote description. Signaling state: "+a.connection.signalingState),a.connection.setRemoteDescription(new RTCSessionDescription(b.message),function(){sa(a),oa(a)},function(a){e.Logger.debug("Set remote description failed. Message: "+JSON.stringify(a))});break;default:e.Logger.debug("Unexpected peer state: "+a.state)}},R=function(a,b){!a||a.state!==h.CONNECTING&&a.state!==h.CONNECTED||(e.Logger.debug("About to set remote description. Signaling state: "+a.connection.signalingState),a.connection.setRemoteDescription(new RTCSessionDescription(b.message),function(){e.Logger.debug("Set remote descripiton successfully."),oa(a),qa(a)},function(a){e.Logger.debug("Set remote description failed. Message: "+a)}))},S=function(a,b){var c;if(c=navigator.mozGetUserMedia?"video":p[a.id]){var e={video:{},audio:!0};"screen"===c?e.video.device="screen":e.video.device="camera";var f=new d.RemoteStream(e);return f.mediaStream=a,f.from=b.id,f}return null},T=function(a,b){e.Logger.debug("Remote stream added.");var c=S(b.stream,a);if(c){var f=new d.StreamEvent({type:"stream-added",senderId:a.id,stream:c});g.dispatchEvent(f)}},U=function(a,b){e.Logger.debug("Remote stream removed.");var c=S(b.stream,a);if(c){var f=new d.StreamEvent({type:"stream-removed",stream:c});g.dispatchEvent(f)}},V=function(a,b){e.Logger.debug("S->C: "+JSON.stringify(b)),"offer"===b.type?Q(a,{message:b}):"answer"===b.type?R(a,{message:b}):"candidates"===b.type&&P(a,{message:b})},W=function(a,b){a&&(e.Logger.debug("Ice connection state changed. State: "+a.connection.iceConnectionState),"closed"===a.connection.iceConnectionState&&a.state===h.CONNECTED&&(B(a,a.id),n&&n.sendChatStopped(a.id),delete o[a.id]),"connected"!==a.connection.iceConnectionState&&"completed"!==a.connection.iceConnectionState||(a.lastDisconnect=new Date("2099/12/31").getTime(),a.state!==h.CONNECTED&&(a.state=h.CONNECTED,g.dispatchEvent(new d.ChatEvent({type:"chat-started",peerId:a.id})))),"checking"===a.connection.iceConnectionState&&(a.lastDisconnect=new Date("2099/12/31").getTime()),"disconnected"===a.connection.iceConnectionState&&(a.lastDisconnect=(new Date).getTime(),setTimeout(function(){(new Date).getTime()-a.lastDisconnect>=m&&(e.Logger.debug("Disconnect timeout."),B(a,a.id),a===o[a.id]&&delete o[a.id])},m)))},X=function(){e.Logger.debug("Add ice candidate success.")},Y=function(a){e.Logger.debug("Add ice candidate failed. Error: "+a)},Z=function(a){e.Logger.debug("Signaling state changed: "+a.connection.signalingState),"closed"===a.connection.signalingState?(B(a,a.id),delete o[a.id]):"stable"===a.connection.signalingState&&(A(a,i.READY),a.isRemoteNegotiationNeeded&&!navigator.mozGetUserMedia&&n?(e.Logger.debug("Send negotiation accept from "+q+" because signaling state changed."),n.sendNegotiationAccepted(a.id),A(a,i.ACCEPTED),a.isRemoteNegotiationNeeded=!1):pa(a))},$=function(a){if(!a||a.connection)return!0;try{a.connection=new RTCPeerConnection(w,t),a.connection.onicecandidate=function(b){O(a,b)},a.connection.onaddstream=function(b){T(a,b)},a.connection.onremovestream=function(b){U(a,b)},a.connection.oniceconnectionstatechange=function(b){W(a,b)},a.connection.onnegotiationneeded=function(){N(a)},a.connection.onsignalingstatechange=function(){Z(a)},a.connection.ondatachannel=function(b){e.Logger.debug(q+": On data channel"),a.dataChannels[b.channel.label]||(a.dataChannels[b.channel.label]=b.channel,e.Logger.debug("Save remote created data channel.")),aa(b.channel,a)}}catch(b){return e.Logger.debug("Failed to create PeerConnection, exception: "+b.message),!1}return!0},_=function(a){a.onicecandidate=void 0,a.onaddstream=void 0,a.onremovestream=void 0,a.oniceconnectionstatechange=void 0,a.onnegotiationneeded=void 0,a.onsignalingstatechange=void 0},aa=function(a,b){a.onmessage=function(a){Ea(b,a)},a.onopen=function(a){Fa(b,a)},a.onclose=function(a){Ga(b,a)},a.onerror=function(a){e.Logger.debug("Data Channel Error:",a)}},ba=function(a,b){b||(b=j.MESSAGE),ca(z(a),b)},ca=function(a,b){var c=o[a];if(c&&!c.dataChannels[b]){e.Logger.debug("Do create data channel.");try{var d=c.connection.createDataChannel(b,u);aa(d,c),c.dataChannels[j.MESSAGE]=d}catch(f){e.Logger.error("Failed to create SendDataChannel, exception: "+f.message)}}},da=function(a){e.Logger.debug("Do renegotiation."),na(a)},ea=function(a){return o[a]||(o[a]={state:h.READY,id:a,pendingStreams:[],pendingUnpublishStreams:[],remoteIceCandidates:[],dataChannels:{},pendingMessages:[],negotiationState:i.READY,lastDisconnect:new Date("2099/12/31").getTime(),publishedStreams:[]}),o[a]},fa=function(a){var b=o[a];if(e.Logger.debug(q+": Remote side needs negotiation."),b){if(b.negotiationState===i.REQUESTED&&y(q,a)>0)return e.Logger.debug("This side already needs negotiation."),void(b.isRemoteNegotiationNeeded=!0);!navigator.mozGetUserMedia&&b.negotiationState!==i.NEGOTIATING&&n?(e.Logger.debug("Send negotiation accept from "+q+" because remote side need negotiation."),n.sendNegotiationAccepted(a),A(b,i.READY),b.isRemoteNegotiationNeeded=!1):(e.Logger.warning("Other reason blocks negotiation."),b.isRemoteNegotiationNeeded=!0)}},ga=function(a){var b=o[a];b&&da(b)},ha=function(a,b,d){n=new c(a),n.onConnected=C,n.onDisconnected=E,n.onConnectFailed=D,n.onChatStopped=I,n.onChatAccepted=H,n.onChatDenied=G,n.onChatInvitation=F,n.onChatSignal=J,n.onStreamType=K,n.onNegotiationNeeded=fa,n.onNegotiationAccepted=ga,n.onAuthenticated=L,n.onForceDisconnect=M,n.connect(a,b,d)},ia=function(a,b){return r?(za(),n&&n.finalize(),n=null,void(a&&a())):void(b&&b(d.Error.P2P_CLIENT_INVALID_STATE))},ja=function(a,b,c){if(!n)return void(c&&c(d.Error.P2P_CONN_CLIENT_NOT_INITIALIZED));if(a===q)return void(c&&c(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT));o[a]||ea(a);var f=o[a];f.state===h.READY||f.state===h.OFFERED?(e.Logger.debug("Send invitation to "+a),f.state=h.OFFERED,n.sendChatInvitation(a,function(){b&&b()},function(a){f.state=h.READY,c&&c(d.Error.getErrorByCode(a))})):(e.Logger.debug("Invalid state. Will not send invitation."),c&&c(d.Error.P2P_CLIENT_INVALID_STATE))},ka=function(a,b,c,d){ja(a,function(){ua(b,a)},d)},la=function(a,b,c){n||c(d.Error.P2P_CONN_CLIENT_NOT_INITIALIZED),o[a]||ea(a);var f=o[a];f.state===h.PENDING?(f.state=h.MATCHED,n.sendChatAccepted(a,b,function(a){f.state=h.PENDING,c(d.Error.getErrorByCode(a))})):(e.Logger.debug("Invalid state. Will not send acceptance."),c&&c(d.Error.P2P_CLIENT_INVALID_STATE))},ma=function(a,b,c,d){la(a,function(){ua(b,a)},d)},na=function(a){return a.connection?"stable"!==a.connection.signalingState?void A(a,i.NEGOTIATING):(pa(a),a.pendingMessages.length&&!a.dataChannels[j.MESSAGE]&&ca(a.id),!navigator.mozGetUserMedia||a.pendingStreams.length||a.connection.getLocalStreams().length||ba(a.id),void a.connection.createOffer(function(b){b.sdp=Ia(b.sdp),a.connection.setLocalDescription(b,function(){e.Logger.debug("Set local descripiton successfully."),A(a,i.READY),n&&n.sendSignalMessage(a.id,b)},function(a){e.Logger.debug("Set local description failed. Message: "+JSON.stringify(a))})},function(a){e.Logger.debug("Create offer failed. Error info: "+JSON.stringify(a))},v)):void e.Logger.error("Peer connection have not been created.")},oa=function(a){if(a&&a.connection&&a.remoteIceCandidates&&0!==a.remoteIceCandidates.length){for(var b=0;b<a.remoteIceCandidates.length;b++)e.Logger.debug("remoteIce, length:"+remoteIceCandidates.length+", current:"+b),a.state!==h.CONNECTED&&a.state!==h.CONNECTING||a.connection.addIceCandidate(remoteIceCandidates[b],X,Y);
a.remoteIceCandidates=[]}},pa=function(a){if(e.Logger.debug("Draining pending streams."),a.connection){e.Logger.debug("Peer connection is ready for draining pending streams.");for(var b=0;b<a.pendingStreams.length;b++){var c=a.pendingStreams[b];c.mediaStream&&(ra(c,a),c.onClose||(c.onClose=function(){Ha(c)}),a.connection.addStream(c.mediaStream),e.Logger.debug("Added stream to peer connection."),xa(c,a),e.Logger.debug("Sent stream type."))}a.pendingStreams=[];for(var d=0;d<a.pendingUnpublishStreams.length;d++)a.pendingUnpublishStreams[d].mediaStream&&(a.connection.removeStream(a.pendingUnpublishStreams[d].mediaStream),e.Logger.debug("Remove stream."));a.pendingUnpublishStreams=[]}},qa=function(a){e.Logger.debug("Draining pendding messages.");var b=a.dataChannels[j.MESSAGE];if(b&&"closed"!==b.readyState){for(var c=0;c<a.pendingMessages.length;c++)b.send(a.pendingMessages[c]);a.pendingMessages=[]}},ra=function(a,b){var c=a.id();s[c]||(s[c]=[]),s[c].push(b.id)},sa=function(a){return a.connection?(pa(a),void a.connection.createAnswer(function(b){b.sdp=Ia(b.sdp),a.connection.setLocalDescription(b,function(){e.Logger.debug("Set local description successfully."),n&&n.sendSignalMessage(a.id,b),e.Logger.debug("Sent answer.")},function(a){e.Logger.error("Error occurred while setting local description. Error message:"+a)})},function(a){e.Logger.error("Create answer failed. Message: "+a)})):void e.Logger.error("Peer connection have not been created.")},ta=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1},ua=function(a,b,c,e){return a instanceof d.LocalStream&&a.mediaStream&&b?void va(a,b,c,e):void(e&&e(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT))},va=function(a,b,c,f){e.Logger.debug("Publish to: "+b);var g=z(b);if(!g)return void(room&&c?c():!room&&f&&f(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT));o[g]||ea(g);var i=o[g];switch(i.state){case h.OFFERED:case h.MATCHED:case h.CONNECTING:case h.CONNECTED:break;default:return e.Logger.warning("Cannot publish stream in this state: "+i.state),void(f&&f(d.Error.P2P_CLIENT_INVALID_STATE))}if(ta(i.publishedStreams,a)>-1)return void(f&&f("The stream has been published."));switch(i.publishedStreams.push(a),l(a)?i.pendingStreams=i.pendingStreams.concat(a):a&&i.pendingStreams.push(a),i.state){case h.CONNECTING:case h.CONNECTED:i.pendingStreams.length>0&&pa(i);break;default:return e.Logger.debug("Unexpected peer state: "+i.state),void(f&&f(d.Error.P2P_CLIENT_INVALID_STATE))}c&&c()},wa=function(a,b,c,f){if(e.Logger.debug("Unpublish stream."),!(a instanceof d.LocalStream))return e.Logger.warning("Invalid argument stream"),void(f&&f(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT));var g=z(b);if(!g)return void(room&&c?c():!room&&f&&(e.Logger.warning("Invalid argument targetId"),f(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)));if(!o[g]||ta(o[g].publishedStreams,a)<0)return void(f&&f(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT));var i=o[g],j=ta(i.publishedStreams,a);i.publishedStreams.splice(j,1),i.pendingUnpublishStreams.push(a),i.state===h.CONNECTED&&pa(i),c&&c()},xa=function(a,b){if(navigator.mozGetUserMedia&&n&&null!==a)return void n.sendStreamType(b.id,{streamId:"default",type:"video"});if(null!==a){var c="audio";a.isScreen()?(c="screen",a.hide=function(){e.Logger.debug("Unpublish screen sharing."),wa(a,b.id)}):a.hasVideo()&&(c="video"),n&&n.sendStreamType(b.id,{streamId:a.mediaStream.id,type:c})}},ya=function(a,b,c){if(o[a]&&o[a].state===h.PENDING){if(!n&&c)return void c(d.Error.P2P_CONN_CLIENT_NOT_INITIALIZED);n.sendChatDenied(a,b,function(a){c&&c(d.Error.getErrorByCode(a))}),delete o[a]}else c&&c(d.Error.P2P_CLIENT_INVALID_STATE)},za=function(a,b,c){if(!n)return void(c&&c(d.Error.P2P_CONN_CLIENT_NOT_INITIALIZED));if(a){var f=o[a];if(!f)return void(c&&(e.Logger.warning("Invalid target ID for stopping chat."),c(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)));n.sendChatStopped(f.id),B(f,q),delete o[a]}else for(var g in o){var h=o[g];n.sendChatStopped(h.id),B(h,q),delete o[h.id]}b&&b()},Aa=function(a,b,c){var d=z(a),e=o[d];e&&e.connection&&e.state===h.CONNECTED||c("failed to get peerconnection statistics"),getPeerConnectionStats(e.connection,b)},Ba=function(a,b,c){var d=z(a),e=o[d];e&&e.connection&&e.state===h.CONNECTED||c("Invalid peer connection status."),getPeerConnectionAudioLevels(e.connection,b,c)},Ca=function(a,b,c,f){return a.length>65535?(e.Logger.warning("Message too long. Max size: 65535."),void(f&&f(d.Error.P2P_CLIENT_ILLEGAL_ARGUMENT))):void Da(a,z(b),c,f)},Da=function(a,b,c,f){var g=o[b];if(!g||g.state!==h.CONNECTED)return void(f&&(e.Logger.error("Invalid peer state."),f(d.Error.P2P_CLIENT_INVALID_STATE)));var i=g.dataChannels[j.MESSAGE];i&&"open"===i.readyState?i.send(a):(g.pendingMessages.push(a),ba(b)),c&&c()},Ea=function(a,b){var c=new d.DataEvent({type:"data-received",senderId:a.id,data:b.data});g.dispatchEvent(c)},Fa=function(a,b){e.Logger.debug("Data Channel is opened"),b.target.label===j.MESSAGE&&(e.Logger.debug("Data channel for messages is opened."),qa(a))},Ga=function(a){e.Logger.debug("Data Channel is closed")},Ha=function(a){var b=s[a.getID()];if(b)for(var c=0;c<b.length;c++)wa(a,b[c])},Ia=function(a){return a=Ja(a),a=Ka(a)},Ja=function(a){var b=/video \d*? RTP\/SAVPF( \d*?)* 96/gi,c=a.match(b);return c&&c.length&&(c[0]=c[0].replace(" 96",""),a=a.replace(b,c[0]),a=a.replace(/a=rtpmap:96 rtx\/90000\r\n/gi,""),a=a.replace(/a=fmtp:96 apt=100\r\n/gi,"")),a},Ka=function(a){var b=/m=video.*\r\n/,c=a.match(b);if(c&&c.length){var d=c[0]+"b=AS:"+(k?k.maxVideoBW:500)+"\r\n";a=a.replace(c[0],d)}return a};return g.connect=ha,g.disconnect=ia,g.invite=ja,g.inviteWithStream=ka,g.publish=ua,g.unpublish=wa,g.deny=ya,g.accept=la,g.acceptWithStream=ma,g.stop=za,g.send=Ca,g.getConnectionStats=Aa,g.getAudioLevels=Ba,g},a.Erizo=f,a.Woogeen=d,a.L=e}(window);
